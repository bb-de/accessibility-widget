import { AccessibilitySettings } from '@/contexts/AccessibilityContext';
import { getTextColorStyles, getTitleColorStyles, getBackgroundColorStyles } from './color-helpers';

// Apply multiple style adjustments based on the active settings
export function applyAccessibilityStyles(settings: AccessibilitySettings): void {
  // Remove any existing accessibility styles
  const existingStyle = document.getElementById('accessibility-styles');
  if (existingStyle) {
    existingStyle.remove();
  }

  // Create a new style element for all accessibility adjustments
  const styleElement = document.createElement('style');
  styleElement.id = 'accessibility-styles';
  
  let cssRules = '';

  // Apply contrast mode styles
  cssRules += getContrastModeStyles(settings.contrastMode);
  
  // Apply custom color adjustments if not in contrast mode
  if (settings.contrastMode === 'default') {
    cssRules += getTextColorStyles(settings.textColor);
    cssRules += getTitleColorStyles(settings.titleColor);
    cssRules += getBackgroundColorStyles(settings.backgroundColor);
  }
  
  // Apply font family
  cssRules += getFontFamilyStyles(settings.fontFamily);
  
  // Apply text adjustments in 2% increments 
  if (settings.textSize !== 0) {
    // Positive increments only (2% per step, starting from 1)
    const adjustment = Math.max(0, settings.textSize) * 2;
    
    // Apply size increase only to site content (not widget)
    cssRules += `
      html {
        --text-size-factor: ${adjustment}%;
      }
      
      /* Headings - maintain hierarchy but scale up */
      h1:not([data-accessibility-widget] h1) { font-size: calc(2em + var(--text-size-factor)) !important; }
      h2:not([data-accessibility-widget] h2) { font-size: calc(1.75em + var(--text-size-factor)) !important; }
      h3:not([data-accessibility-widget] h3) { font-size: calc(1.5em + var(--text-size-factor)) !important; }
      h4:not([data-accessibility-widget] h4) { font-size: calc(1.25em + var(--text-size-factor)) !important; }
      h5:not([data-accessibility-widget] h5) { font-size: calc(1.1em + var(--text-size-factor)) !important; }
      h6:not([data-accessibility-widget] h6) { font-size: calc(1em + var(--text-size-factor)) !important; }
      
      /* Other text elements */
      p:not([data-accessibility-widget] p),
      div:not([data-accessibility-widget]):not([data-accessibility-widget] div),
      span:not([data-accessibility-widget] span),
      li:not([data-accessibility-widget] li),
      a:not([data-accessibility-widget] a),
      button:not([data-accessibility-widget] button),
      input:not([data-accessibility-widget] input),
      textarea:not([data-accessibility-widget] textarea),
      select:not([data-accessibility-widget] select) {
        font-size: calc(1em + var(--text-size-factor)) !important;
      }
    `;
  }
  
  // Apply line height
  if (settings.lineHeight !== 0) {
    cssRules += `
      p, div, span, li {
        line-height: ${1.5 + (settings.lineHeight * 0.15)} !important;
      }
      
      /* Exclude accessibility widget */
      [data-accessibility-widget] p,
      [data-accessibility-widget] div,
      [data-accessibility-widget] span,
      [data-accessibility-widget] li {
        line-height: initial !important;
      }
    `;
  }
  
  // Apply letter spacing
  if (settings.letterSpacing !== 0) {
    cssRules += `
      body, p, div, span, li, a, h1, h2, h3, h4, h5, h6, button, input, textarea, select {
        letter-spacing: ${settings.letterSpacing * 0.05}em !important;
      }
      
      /* Exclude accessibility widget */
      [data-accessibility-widget],
      [data-accessibility-widget] * {
        letter-spacing: normal !important;
      }
    `;
  }
  
  // Apply word spacing
  if (settings.wordSpacing > 0) {
    cssRules += `
      body, p, div, span, li, a, h1, h2, h3, h4, h5, h6, button, input, textarea, select {
        word-spacing: ${settings.wordSpacing * 0.05}em !important;
      }
      
      /* Exclude accessibility widget */
      [data-accessibility-widget],
      [data-accessibility-widget] * {
        word-spacing: normal !important;
      }
    `;
  }
  
  // Apply text alignment
  if (settings.textAlign !== 'default') {
    let alignValue = 'left';
    
    if (settings.textAlign === 'center') {
      alignValue = 'center';
    } else if (settings.textAlign === 'right') {
      alignValue = 'right';
    }
    
    cssRules += `
      /* Apply text alignment to all content elements EXCEPT the widget */
      html body p:not([data-accessibility-widget="true"] p):not([data-accessibility-widget="true"] *),
      html body div:not([data-accessibility-widget="true"]):not([data-accessibility-widget="true"] *),
      html body li:not([data-accessibility-widget="true"] li):not([data-accessibility-widget="true"] *),
      html body h1:not([data-accessibility-widget="true"] h1):not([data-accessibility-widget="true"] *),
      html body h2:not([data-accessibility-widget="true"] h2):not([data-accessibility-widget="true"] *),
      html body h3:not([data-accessibility-widget="true"] h3):not([data-accessibility-widget="true"] *),
      html body h4:not([data-accessibility-widget="true"] h4):not([data-accessibility-widget="true"] *),
      html body h5:not([data-accessibility-widget="true"] h5):not([data-accessibility-widget="true"] *),
      html body h6:not([data-accessibility-widget="true"] h6):not([data-accessibility-widget="true"] *) {
        text-align: ${alignValue} !important;
      }
    `;
  }
  
  // Apply highlight titles
  if (settings.highlightTitles) {
    cssRules += `
      /* Apply only to heading elements EXCEPT the widget */
      html body h1:not([data-accessibility-widget="true"] h1):not([data-accessibility-widget="true"] *),
      html body h2:not([data-accessibility-widget="true"] h2):not([data-accessibility-widget="true"] *),
      html body h3:not([data-accessibility-widget="true"] h3):not([data-accessibility-widget="true"] *),
      html body h4:not([data-accessibility-widget="true"] h4):not([data-accessibility-widget="true"] *),
      html body h5:not([data-accessibility-widget="true"] h5):not([data-accessibility-widget="true"] *),
      html body h6:not([data-accessibility-widget="true"] h6):not([data-accessibility-widget="true"] *) {
        background-color: #ffffcc !important;
        border: 1px solid #e6e600 !important;
        padding: 2px 5px !important;
      }
    `;
  }
  
  // Apply highlight links
  if (settings.highlightLinks) {
    cssRules += `
      /* Apply only to content elements EXCEPT the widget */
      html body a:not([data-accessibility-widget="true"] a):not([data-accessibility-widget="true"] *),
      html body button:not([data-accessibility-widget="true"] button):not([data-accessibility-widget="true"] *),
      html body [role="button"]:not([data-accessibility-widget="true"] [role="button"]):not([data-accessibility-widget="true"] *),
      html body [role="link"]:not([data-accessibility-widget="true"] [role="link"]):not([data-accessibility-widget="true"] *) {
        background-color: #ffff00 !important;
        color: #000000 !important;
        border: 1px solid #e6e600 !important;
        text-decoration: underline !important;
        padding: 2px 5px !important;
        font-weight: bold !important;
      }
    `;
  }
  
  // Apply hide images
  if (settings.hideImages) {
    cssRules += `
      img, svg, picture, video, canvas, [role="img"] {
        display: none !important;
      }
      
      /* Exclude accessibility widget */
      [data-accessibility-widget] img,
      [data-accessibility-widget] svg,
      [data-accessibility-widget] picture,
      [data-accessibility-widget] video,
      [data-accessibility-widget] canvas,
      [data-accessibility-widget] [role="img"] {
        display: initial !important;
      }
    `;
  }
  
  // Apply stop animations
  if (settings.stopAnimations) {
    cssRules += `
      *, *::before, *::after {
        animation: none !important;
        transition: none !important;
      }
      
      /* Exclude accessibility widget */
      [data-accessibility-widget],
      [data-accessibility-widget] *,
      [data-accessibility-widget] *::before,
      [data-accessibility-widget] *::after {
        animation: initial !important;
        transition: initial !important;
      }
    `;
  }
  
  // Apply highlight focus
  if (settings.highlightFocus) {
    cssRules += `
      *:focus {
        outline: 3px solid #ff6600 !important;
        outline-offset: 2px !important;
      }
    `;
  }
  
  // Apply custom cursor styles
  if (settings.customCursor) {
    // Determine the cursor size multiplier
    let cursorScale = 1.0; // default size
    if (settings.cursorSize === 'big') {
      cursorScale = 1.5;
    } else if (settings.cursorSize === 'bigger') {
      cursorScale = 2.0;
    } else if (settings.cursorSize === 'biggest') {
      cursorScale = 2.5;
    }
    
    // Apply cursor style using CSS
    cssRules += `
      * {
        cursor: ${settings.cursorColor === 'white' ? 'url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAhCAYAAABX5MJvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAF0WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDAgNzkuMTYwNDUxLCAyMDE3LzA1LzA2LTAxOjA4OjIxICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOCAoTWFjaW50b3NoKSIgeG1wOkNyZWF0ZURhdGU9IjIwMTktMDYtMjZUMTU6MDg6MDcrMDI6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDE5LTA2LTI2VDE1OjEyOjU2KzAyOjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDE5LTA2LTI2VDE1OjEyOjU2KzAyOjAwIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgcGhvdG9zaG9wOklDQ1Byb2ZpbGU9InNSR0IgSUVDNjE5NjYtMi4xIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjhlZmUwZWU4LTYyZDktNGQxYy05MzVkLTY2OGI4MzFmMWI3NyIgeG1wTU06RG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjdlYTBmM2E3LWFlOWMtZDk0MC1hMDU5LWI0MDQxNTQyZjM0MSIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOjhmZDM0MWJkLThhYzMtNDUxNi04M2I2LTgxMmQzNDRjMjc0YyI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6OGZkMzQxYmQtOGFjMy00NTE2LTgzYjYtODEyZDM0NGMyNzRjIiBzdEV2dDp3aGVuPSIyMDE5LTA2LTI2VDE1OjA4OjA3KzAyOjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOCAoTWFjaW50b3NoKSIvPiA8cmRmOmxpIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6OGVmZTBlZTgtNjJkOS00ZDFjLTkzNWQtNjY4YjgzMWYxYjc3IiBzdEV2dDp3aGVuPSIyMDE5LTA2LTI2VDE1OjEyOjU2KzAyOjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOCAoTWFjaW50b3NoKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5VPB9MAAAB8ElEQVRYhc2YMU4bQRSGvxFKinSuwA0gu3RJwQVSuDFCAkmZ0lBxBhcUkRLFJZQpHSUSEjVdLocFGyf2zM57M+sUfNLKq33z5v/3nZ3dHQlJVN+ALvAR6AC31DGW0wGepXDaDSR5MdFX4C2MqrZxk5Jdp6QgBkGw2YrxiwWBnxbJ9pLg1zjQNwZ9xhqDnQs6nAbULwZgbAFG5yVA3wHMgRmwBuKKGIsxj+pPE5j1kfSQNJY0lXQr6btjPaqbSrprvLs0gCFDJ0nL64hbStK8cTg7D7oT7Ckw7qW/rUAfgUkq6M0BmCbonwo0hAPfWgDjAF+tQG3o1gIYKx4cA2xrsDIAZlbEEdhNgVkFMDNLsAmKaYPP+4amBeGP1QYzWcM9pPXutlnCXnR0JD0JOvT7X7JeDXIeRgxgblAqvzSU/ABq0ZM2GLeLDLNAsZE2HgdRo7JJm6f/a5PmTkm9t2JSckpp0+uCLw30TUNuKV1brpP1ldxJ8M4EaoPXjFk1zXQAYJxsUUZZD4EiLQfA5IfVZQJOA9hhB3RqQF+o4gWVtx2Cs+8DoCwXujbxPbCi3kWXwA46y21YK1iT+iG4sI5fgSeqc9YBPnD8l5Tz9yrgK3CUZDV1lJ7Gb9PXFmdsLOO2AAAAAElFTkSuQmCC") 5 5' : 
                settings.cursorColor === 'black' ? 'url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAhCAYAAABX5MJvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAF0WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDAgNzkuMTYwNDUxLCAyMDE3LzA1LzA2LTAxOjA4OjIxICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOCAoTWFjaW50b3NoKSIgeG1wOkNyZWF0ZURhdGU9IjIwMTktMDYtMjZUMTU6MDg6MDcrMDI6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDE5LTA2LTI2VDE1OjEyOjU2KzAyOjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDE5LTA2LTI2VDE1OjEyOjU2KzAyOjAwIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgcGhvdG9zaG9wOklDQ1Byb2ZpbGU9InNSR0IgSUVDNjE5NjYtMi4xIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjhlZmUwZWU4LTYyZDktNGQxYy05MzVkLTY2OGI4MzFmMWI3NyIgeG1wTU06RG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjdlYTBmM2E3LWFlOWMtZDk0MC1hMDU5LWI0MDQxNTQyZjM0MSIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOjhmZDM0MWJkLThhYzMtNDUxNi04M2I2LTgxMmQzNDRjMjc0YyI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6OGZkMzQxYmQtOGFjMy00NTE2LTgzYjYtODEyZDM0NGMyNzRjIiBzdEV2dDp3aGVuPSIyMDE5LTA2LTI2VDE1OjA4OjA3KzAyOjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOCAoTWFjaW50b3NoKSIvPiA8cmRmOmxpIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6OGVmZTBlZTgtNjJkOS00ZDFjLTkzNWQtNjY4YjgzMWYxYjc3IiBzdEV2dDp3aGVuPSIyMDE5LTA2LTI2VDE1OjEyOjU2KzAyOjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOCAoTWFjaW50b3NoKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5VPB9MAAAB8ElEQVRYhc2YMU4bQRSGvxFKinSuwA0gu3RJwQVSuDFCAkmZ0lBxBhcUkRLFJZQpHSUSEjVdLocFGyf2zM57M+sUfNLKq33z5v/3nZ3dHQlJVN+ALvAR6AC31DGW0wGepXDaDSR5MdFX4C2MqrZxk5Jdp6QgBkGw2YrxiwWBnxbJ9pLg1zjQNwZ9xhqDnQs6nAbULwZgbAFG5yVA3wHMgRmwBuKKGIsxj+pPE5j1kfSQNJY0lXQr6btjPaqbSrprvLs0gCFDJ0nL64hbStK8cTg7D7oT7Ckw7qW/rUAfgUkq6M0BmCbonwo0hAPfWgDjAF+tQG3o1gIYKx4cA2xrsDIAZlbEEdhNgVkFMDNLsAmKaYPP+4amBeGP1QYzWcM9pPXutlnCXnR0JD0JOvT7X7JeDXIeRgxgblAqvzSU/ABq0ZM2GLeLDLNAsZE2HgdRo7JJm6f/a5PmTkm9t2JSckpp0+uCLw30TUNuKV1brpP1ldxJ8M4EaoPXjFk1zXQAYJxsUUZZD4EiLQfA5IfVZQJOA9hhB3RqQF+o4gWVtx2Cs+8DoCwXujbxPbCi3kWXwA46y21YK1iT+iG4sI5fgSeqc9YBPnD8l5Tz9yrgK3CUZDV1lJ7Gb9PXFmdsLOO2AAAAAElFTkSuQmCC") 5 5' : 
                settings.cursorColor === 'blue' ? 'url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAhCAYAAABX5MJvAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjM4REY0N0YwQTk4NDExRTk5RDkxRTREQUE4MUMwQjJBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjM4REY0N0YxQTk4NDExRTk5RDkxRTREQUE4MUMwQjJBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6MzhERjQ3RUVBOTg0MTFFOTlEOTFFNERBQTgxQzBCMkEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MzhERjQ3RUZBOTg0MTFFOTlEOTFFNERBQTgxQzBCMkEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6OKwGEAAAB7ElEQVR42syYvStGURzHrze3ScmgDBT5Mxgkg5SiwWCQMloppWQ0ykCZRAbZzQZ/gWxSFnUHKQODyE0+z+l36pw8j+dxznnum770q9vz3M/5nPfc8zxnJpPJ/HpwAJSAbFAMcsEXCGMnQBTU17R3uq84MclPoAi8wpw6GrcqYesRCWIRA86xKPpFpBCLRSh7E8mvZZB1UlojgLcW0HkE0E8C84BIIEaBtRHQZwLMDzBfQAq4lIxFmId0fxTwXCbpdWAraTSCkQQ1SdrXJJ4C2kthfSZkbS2STpJ2jaTQFKCZBWjXkoIzDYYqQNMKYKzQ4JIBzBVgFACzCmMXBrEIgTnzgPkEzDWKVVBOQ0CZgDQJ2oCdAvfUAHYTiB6w7QPTTwAyJJ50gGCQeRVgBsBx0BqwM5K+KLAPgOm2gHSxvUraLmxKaCfqHU+SJokk0UGSWaAQXAFbD6YfAVQCTAeZ1wLTQTB1HPuJeDsV2BnARdAm0BnG1lKYSd2g4hQYlRXoMZgtgWkEvEf0GeipgLmjQEqGjAPmMHg/6ItgQV0KHvs/7QK0Fb9XlwljC+wgLcK6TLspYB71APMimLfzCiYVr0GPxPUCOAKG6G6aDzrAzldS7vdVwGvgpciS6yjtjV86wLiRlNKmAAAAAElFTkSuQmCC") 5 5' :
                settings.cursorColor === 'red' ? 'url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAhCAYAAABX5MJvAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjNEMTc0MUJCQTk4NDExRTk5N0NDQzUyRTQ5MDAzRkIzIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjNEMTc0MUJDQTk4NDExRTk5N0NDQzUyRTQ5MDAzRkIzIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6M0QxNzQxQjlBOTg0MTFFOTk3Q0NDNTJFNDkwMDNGQjMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6M0QxNzQxQkFBOTg0MTFFOTk3Q0NDNTJFNDkwMDNGQjMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz56871WAAAB7ElEQVR42syYvStGURzHrze3ScmgDBT5MxgkAyWiwWCQMloZlIxGZaBMIoPs5i7+AtkNFilKGRgs1OXzPadfrXPz8Dzec873fPdLv7r3vs/9nM855/56MplM5tODQ6CI6wT5IBu8g1bsOEiBxp7+Tvc1JSP5FRTyq2FWQxM2FWLziARxCYI2WxT/JVIXb8OyvSr5tQGyvgprBuC1BXRfAvSLwHwgEohxYB0E9IsB8wvMLxADbiVj4eZJ3R8FPE9Jek3YqvBPXHRIulYkngF2kaT/JmRtVZLOknZWSWFXgGYxoF1NCk41GJoATSuAsdLgkgHMNWDkALMUxi4MYuEDcxkA8wWYWxSroJzGgLIRSBO4DcCeYve5B+wmEN1gxwemXwNkkHjSAYJB5nUAGYDTwxqw85K+KLD3gOm2gHSxvUvazm2q0E7WO54kTQtJokOSWYf9S7ANYPoBQDnAcJJ5LTAcBFMnsJ+IFyxglwCXQptAZxhbS2EmXQcV5wFj/Qh6IpgCwLtET4OeCpj7DiTO+Q+YyfjK0XvB4ixgsXYu6+9z2y0WQK06wNyXAXgugbkXzOvYgoNJxKMzJHl9Ao6BIZH2eaCT7bGScr+vAt4CZ0FWSKewt34BGD/pPWs5QNgAAAAASUVORK5CYII=") 5 5' :
                settings.cursorColor === 'green' ? 'url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAhCAYAAABX5MJvAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjM4REY0N0Y0QTk4NDExRTk5RDkxRTREQUE4MUMwQjJBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjM4REY0N0Y1QTk4NDExRTk5RDkxRTREQUE4MUMwQjJBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6MzhERjQ3RjJBOTg0MTFFOTlEOTFFNERBQTgxQzBCMkEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MzhERjQ3RjNBOTg0MTFFOTlEOTFFNERBQTgxQzBCMkEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5aQ8TgAAAB7ElEQVR42syYvStGcRzHr8mSksFg8FKUUuxeIoOURUkpk/fNKINJBoukmGSQxaQY/AWyK4OkRBazDFLiP/h8T9/qd+rp8XKe73nu933u536eX53bc+/vfb7fc77nOb8+n8/n+/bgENjlOkExKARfwB/YfhADTXXdne7flFXIb6CYXwWzbE3Zd4jNx1YQlyCQYbMiHolziJsg2dsq5Bec0mYCeKsBXTcAnRWYV0QC0Q+stQDdYsC8AXMPpIAbwViYORX39wLuJyTpMWHrGe1lMl7GC24imC4JS03C1loh6SwpW4QMlQHNPEC7ihScqzDUBmjoALEzFZc0YG4AIw+YWR9YhEEs0sB0AjAvwNyhWBnltAQoGwRpArcG2EsUu30P2E0gesFkDmga0QAySjzuAMEg82rAGABnijVglyR1WWAfAM1whXSxf0iqLm2q0E7WOx5PmiaSRAckWQb7R2Dzwe0XAWYfpONV9jXAcBBMLQdbxr6Rb2AXAE9C20CnH1tNYSZdB5aOwMxJQLQGgG2OXoXecMDccTBxz3/ATMdXnj4LbtR5lO8bzK37Xwa2SgPMXRGA544w93wJnolHZ0Ty+hw4BsaeNsYFoIPtsZJy/a8C3gBnZiwtdYq89Vt88HcJhavE5AAAAABJRU5ErkJggg==") 5 5' :
                settings.cursorColor === 'yellow' ? 'url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAhCAYAAABX5MJvAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjNEMTc0MUJGQTk4NDExRTk5N0NDQzUyRTQ5MDAzRkIzIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjNEMTc0MUMwQTk4NDExRTk5N0NDQzUyRTQ5MDAzRkIzIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6M0QxNzQxQkRBOTg0MTFFOTk3Q0NDNTJFNDkwMDNGQjMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6M0QxNzQxQkVBOTg0MTFFOTk3Q0NDNTJFNDkwMDNGQjMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6OAIP0AAAB7ElEQVR42syYvUtcURTGn3E3xUILC8FgYMEqIfYL/AMELbZZCBIlpE5EsQgkkASxETsNVhYKCUIQQiwsU0RRkD9AwSYmYjOdgmXA3zvzYu7kvPvcOXO/7gs/duZ7z9zfmfPunLlXGWPUVwcHQIprAcXgC/gCm8exIAZa6ro7/U8ra5O/gGJ+NZhla5OWk9ijbRLXQViBbYpxkyiBuImk2yaS3xRJ1kVoIwO8pYBOJwGddzBvgBiiH1gbAdolwLwD8wAUgSvPWJj5Lu7/DlyfkaRXgrUZrdvJeJPw4J4B7Cph6RixtEpIuknKxpJCXYCmMaBdQwrOVBjqBDRMALGFiksxYG4BI8+GWfWBKRvEIgZm6gHzCZg7FEtXTktA2XGQxnDHgD3G7ksTsMtB9IIZI5ipjwYkI8TjTjAMMq8CmAE4LlaDXZa0RcA+AJrhDuly/5CUnbtQoZ2tFzxOujaSRAfEWQL7R2DzweM3Aczep+Ix9lXAeDBMrcCOwdgot7DzgAtPm0CnHxtNYYauA0vHwExlQK0EiG2OXom+rgPmTm2C470BTJU/cnQbLGE1ux5h7nWxBRtpdzoxJa+HwDEwZFpjLwMdbJ+1lPv/KeAtcGa8UvZS7q0/UiUx/3CeBDwAAAAASUVORK5CYII=") 5 5' :
                settings.cursorColor === 'purple' ? 'url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAhCAYAAABX5MJvAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjNEMTc0MUMzQTk4NDExRTk5N0NDQzUyRTQ5MDAzRkIzIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjNEMTc0MUM0QTk4NDExRTk5N0NDQzUyRTQ5MDAzRkIzIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6M0QxNzQxQzFBOTg0MTFFOTk3Q0NDNTJFNDkwMDNGQjMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6M0QxNzQxQzJBOTg0MTFFOTk3Q0NDNTJFNDkwMDNGQjMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5kcvqBAAAB6klEQVR42syYv0vDQBTH37WWLg4tCIJD/QMcdHJycnFwdnAQh+LgIjjppDgIQsFRcHNwdBKKi4L4B4ggCJWCS6Hq56RXzzQmae5y8e7wocnlkvfJ5d57l1REJCcGx8As1xyQBh/gC2wMJcAymO7r7/S/JlnI30GO/2owrdbMKzniEdBBrIJYAMMGmxJHJerAPaTFKyu/ToC1G8CcM0D3A4D2G5hXQBAxCqy1A911gLkG5g5MgksyrABnT9z/BrhuSdJTwdJM1nVkvMx4sOIAux/BurVA2nHSNivZaQRoewBtJSl4HsFQBaBhA4iVoXiXAHMJmCI3zLIFpsxBrBJgJgmYT2Dukazbzakd0kYRpBHcLGCPo/1mFtiUELKQDYOZ+MlAMkw8XgfDIPOGgTEATgrLQFdN6nLAXgOaUQNpY3uT1L3XqYJuaC/9TLpWkkQHJJkZ+yOwMeD2E8AsVZqPZF8RDAcRqZnZOYuNlW9hp8CN0EbQG42NFWFG3geWZoHZ5YN3PYTYkegN9vWEdXsMTDzzHzDT4sqSPgtm1VZcb5S5DcwU0UgTDlzx7Myj10mwJ3l9AI6BAdMaewFMs71VUq7/V8Ar4FSsUrUVXvplBUIoP9CXNmYAAAAASUVORK5CYII=") 5 5' : 
                'auto'}!important;
        
        transform: scale(${cursorScale});
        transform-origin: 0 0;
      }
      
      /* Exclude accessibility widget */
      [data-accessibility-widget],
      [data-accessibility-widget] * {
        cursor: initial !important;
        transform: none !important;
      }
    `;
  }
  
  // Apply saturation and monochrome filters
  if (settings.saturation !== 100 || settings.monochrome > 0) {
    const filterValues = [];
    
    if (settings.saturation !== 100) {
      filterValues.push(`saturate(${settings.saturation}%)`);
    }
    
    if (settings.monochrome > 0) {
      filterValues.push(`grayscale(${settings.monochrome}%)`);
    }
    
    const filterValue = filterValues.join(' ');
    
    cssRules += `
      html, img, video {
        filter: ${filterValue} !important;
      }
    `;
  }
  
  // Apply dark mode
  if (settings.darkMode) {
    cssRules += `
      html {
        filter: invert(100%) hue-rotate(180deg) !important;
      }
      img, video {
        filter: invert(100%) hue-rotate(180deg) !important;
      }
      
      /* Exclude accessibility widget */
      [data-accessibility-widget],
      [data-accessibility-widget] * {
        filter: none !important;
      }
      [data-accessibility-widget] img,
      [data-accessibility-widget] video {
        filter: none !important;
      }
    `;
  }
  
  // Apply reading mask
  if (settings.readingMask) {
    // Prüfe, ob die Maske bereits existiert
    let topMask = document.getElementById('reading-mask-top');
    let bottomMask = document.getElementById('reading-mask-bottom');
    let focusStrip = document.getElementById('reading-mask-focus');
    
    if (!topMask && !bottomMask) {
      // Erstelle gemeinsame Eigenschaften
      const maskBaseStyles = {
        position: 'fixed',
        left: '0',
        width: '100%',
        backgroundColor: 'rgba(0, 0, 0, 0.4)',
        pointerEvents: 'none',
        zIndex: '999999'
      };
      
      // Top Maske erstellen
      topMask = document.createElement('div');
      topMask.id = 'reading-mask-top';
      Object.assign(topMask.style, maskBaseStyles, {
        top: '0'
      });
      
      // Bottom Maske erstellen
      bottomMask = document.createElement('div');
      bottomMask.id = 'reading-mask-bottom';
      Object.assign(bottomMask.style, maskBaseStyles, {
        bottom: '0'
      });
      
      // Fokus-Streifen erstellen (sichtbare Lesezone)
      focusStrip = document.createElement('div');
      focusStrip.id = 'reading-mask-focus';
      Object.assign(focusStrip.style, {
        position: 'fixed',
        left: '0',
        width: '100%',
        height: '100px',
        border: '2px solid rgba(255, 255, 0, 0.5)',
        boxSizing: 'border-box',
        backgroundColor: 'transparent',
        pointerEvents: 'none',
        zIndex: '999999'
      });
      
      // Elemente dem Body hinzufügen
      document.body.appendChild(topMask);
      document.body.appendChild(bottomMask);
      document.body.appendChild(focusStrip);
      
      // Mausbewegungs-Handler hinzufügen
      document.addEventListener('mousemove', function handleMouseMove(e) {
        if (!settings.readingMask) {
          document.removeEventListener('mousemove', handleMouseMove);
          return;
        }
        
        const focusHeight = 100; // Höhe des sichtbaren Bereichs
        const mouseY = e.clientY;
        const windowHeight = window.innerHeight;
        
        // Berechne die Position der Masken
        const focusStripTop = mouseY - focusHeight / 2;
        const topMaskHeight = Math.max(0, focusStripTop);
        const bottomMaskTop = Math.min(windowHeight, mouseY + focusHeight / 2);
        const bottomMaskHeight = Math.max(0, windowHeight - bottomMaskTop);
        
        // Aktualisiere die Masken-Positionen
        if (topMask) {
          topMask.style.height = `${topMaskHeight}px`;
        }
        
        if (bottomMask) {
          bottomMask.style.top = `${bottomMaskTop}px`;
          bottomMask.style.height = `${bottomMaskHeight}px`;
        }
        
        if (focusStrip) {
          focusStrip.style.top = `${focusStripTop}px`;
        }
      });
    }
  } else {
    // Entferne alle Maskenelemente, wenn deaktiviert
    const elementsToRemove = [
      'reading-mask-top',
      'reading-mask-bottom',
      'reading-mask-focus'
    ];
    
    elementsToRemove.forEach(id => {
      const element = document.getElementById(id);
      if (element) element.remove();
    });
  }
  
  // Apply reading guide
  if (settings.readingGuide) {
    const guideElement = document.getElementById('reading-guide');
    if (!guideElement) {
      const guide = document.createElement('div');
      guide.id = 'reading-guide';
      guide.style.position = 'fixed';
      guide.style.left = '0';
      guide.style.width = '100%';
      guide.style.height = '30px';
      guide.style.backgroundColor = 'rgba(255, 255, 0, 0.2)';
      guide.style.border = '1px solid rgba(255, 255, 0, 0.5)';
      guide.style.pointerEvents = 'none';
      guide.style.zIndex = '9999';
      
      document.body.appendChild(guide);
      
      // Update guide position with mouse movement
      document.addEventListener('mousemove', (e) => {
        if (!settings.readingGuide) return;
        
        const guide = document.getElementById('reading-guide');
        if (guide) {
          guide.style.top = `${e.clientY - 15}px`;
        }
      });
    }
  } else {
    // Remove reading guide if disabled
    const guide = document.getElementById('reading-guide');
    if (guide) guide.remove();
  }
  
  // Apply text-to-speech functionality
  if (settings.textToSpeech) {
    // Add event listeners for elements that should be read
    document.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, a, button, label').forEach(element => {
      if (!element.getAttribute('data-tts-attached')) {
        element.setAttribute('data-tts-attached', 'true');
        element.addEventListener('click', (e) => {
          if (!settings.textToSpeech) return;
          
          const text = element.textContent;
          if (text && window.speechSynthesis) {
            // Cancel any ongoing speech
            window.speechSynthesis.cancel();
            
            // Create a new speech utterance
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = document.documentElement.lang || 'en-US';
            
            // Speak the text
            window.speechSynthesis.speak(utterance);
            
            // Prevent default action for links and buttons
            if (element.tagName === 'A' || element.tagName === 'BUTTON') {
              e.preventDefault();
            }
          }
        });
      }
    });
  } else {
    // Clean up TTS event listeners if disabled
    document.querySelectorAll('[data-tts-attached]').forEach(element => {
      element.removeAttribute('data-tts-attached');
      // We would need to clone and replace elements to properly remove event listeners,
      // but that's beyond the scope of this implementation
    });
  }
  
  // Apply page structure functionality
  if (settings.pageStructure) {
    const structureElement = document.getElementById('page-structure');
    if (!structureElement) {
      // Create structure panel
      const structure = document.createElement('div');
      structure.id = 'page-structure';
      structure.style.position = 'fixed';
      structure.style.top = '10px';
      structure.style.left = '10px';
      structure.style.backgroundColor = 'white';
      structure.style.border = '1px solid #ccc';
      structure.style.borderRadius = '5px';
      structure.style.padding = '10px';
      structure.style.zIndex = '9998';
      structure.style.maxHeight = '80vh';
      structure.style.overflowY = 'auto';
      structure.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
      
      // Add close button
      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'Close';
      closeBtn.style.position = 'absolute';
      closeBtn.style.top = '5px';
      closeBtn.style.right = '5px';
      closeBtn.style.padding = '2px 5px';
      closeBtn.style.backgroundColor = '#f0f0f0';
      closeBtn.style.border = '1px solid #ccc';
      closeBtn.style.borderRadius = '3px';
      closeBtn.addEventListener('click', () => {
        const structure = document.getElementById('page-structure');
        if (structure) structure.remove();
      });
      
      // Add page structure content
      const heading = document.createElement('h3');
      heading.textContent = 'Page Structure';
      heading.style.marginTop = '20px';
      heading.style.marginBottom = '10px';
      
      structure.appendChild(closeBtn);
      structure.appendChild(heading);
      
      // Extract and display headings
      const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
      if (headings.length > 0) {
        const headingList = document.createElement('ul');
        headingList.style.listStyleType = 'none';
        headingList.style.padding = '0';
        headingList.style.margin = '0';
        
        headings.forEach(heading => {
          const level = parseInt(heading.tagName.substring(1));
          const item = document.createElement('li');
          const link = document.createElement('a');
          link.textContent = heading.textContent || '';
          link.href = '#';
          link.style.textDecoration = 'none';
          link.style.color = '#0066cc';
          link.style.paddingLeft = `${(level - 1) * 15}px`;
          link.style.display = 'block';
          link.style.padding = '5px 0';
          
          link.addEventListener('click', (e) => {
            e.preventDefault();
            heading.scrollIntoView({ behavior: 'smooth' });
          });
          
          item.appendChild(link);
          headingList.appendChild(item);
        });
        
        structure.appendChild(headingList);
      } else {
        const noHeadings = document.createElement('p');
        noHeadings.textContent = 'No headings found in the page.';
        structure.appendChild(noHeadings);
      }
      
      document.body.appendChild(structure);
    }
  } else {
    // Remove page structure if disabled
    const structure = document.getElementById('page-structure');
    if (structure) structure.remove();
  }
  
  // Apply virtual keyboard if enabled
  if (settings.virtualKeyboard) {
    const keyboardElement = document.getElementById('virtual-keyboard');
    if (!keyboardElement) {
      // Create keyboard container
      const keyboard = document.createElement('div');
      keyboard.id = 'virtual-keyboard';
      keyboard.style.position = 'fixed';
      keyboard.style.bottom = '0';
      keyboard.style.left = '0';
      keyboard.style.width = '100%';
      keyboard.style.backgroundColor = '#f0f0f0';
      keyboard.style.borderTop = '1px solid #ccc';
      keyboard.style.padding = '10px';
      keyboard.style.zIndex = '9997';
      keyboard.style.display = 'flex';
      keyboard.style.flexWrap = 'wrap';
      keyboard.style.justifyContent = 'center';
      
      // Define key rows
      const rows = [
        ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0', 'Backspace'],
        ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'],
        ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l'],
        ['z', 'x', 'c', 'v', 'b', 'n', 'm', ',', '.', '?'],
        ['Space']
      ];
      
      // Create keyboard rows
      rows.forEach(row => {
        const rowElement = document.createElement('div');
        rowElement.style.display = 'flex';
        rowElement.style.justifyContent = 'center';
        rowElement.style.width = '100%';
        rowElement.style.margin = '5px 0';
        
        row.forEach(key => {
          const keyButton = document.createElement('button');
          keyButton.textContent = key === 'Space' ? ' ' : key;
          keyButton.setAttribute('data-key', key === 'Space' ? ' ' : key);
          keyButton.style.margin = '2px';
          keyButton.style.padding = '10px';
          keyButton.style.minWidth = key === 'Space' ? '300px' : '40px';
          keyButton.style.height = '40px';
          keyButton.style.borderRadius = '5px';
          keyButton.style.border = '1px solid #ccc';
          keyButton.style.backgroundColor = 'white';
          keyButton.style.cursor = 'pointer';
          
          // Add key press functionality
          keyButton.addEventListener('click', () => {
            // Get active element
            const activeElement = document.activeElement as HTMLInputElement;
            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
              const start = activeElement.selectionStart || 0;
              const end = activeElement.selectionEnd || 0;
              
              // Handle special keys
              if (key === 'Backspace') {
                if (start === end && start > 0) {
                  activeElement.value = activeElement.value.substring(0, start - 1) + activeElement.value.substring(end);
                  activeElement.selectionStart = activeElement.selectionEnd = start - 1;
                } else {
                  activeElement.value = activeElement.value.substring(0, start) + activeElement.value.substring(end);
                  activeElement.selectionStart = activeElement.selectionEnd = start;
                }
              } else {
                // Insert key character
                const keyChar = key === 'Space' ? ' ' : key;
                activeElement.value = activeElement.value.substring(0, start) + keyChar + activeElement.value.substring(end);
                activeElement.selectionStart = activeElement.selectionEnd = start + 1;
              }
              
              // Trigger input event
              const inputEvent = new Event('input', { bubbles: true });
              activeElement.dispatchEvent(inputEvent);
            }
          });
          
          rowElement.appendChild(keyButton);
        });
        
        keyboard.appendChild(rowElement);
      });
      
      // Close button
      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'Close Keyboard';
      closeBtn.style.width = '100%';
      closeBtn.style.padding = '10px';
      closeBtn.style.marginTop = '10px';
      closeBtn.style.backgroundColor = '#ddd';
      closeBtn.style.border = '1px solid #ccc';
      closeBtn.style.borderRadius = '5px';
      closeBtn.style.cursor = 'pointer';
      
      closeBtn.addEventListener('click', () => {
        const keyboard = document.getElementById('virtual-keyboard');
        if (keyboard) keyboard.remove();
      });
      
      keyboard.appendChild(closeBtn);
      document.body.appendChild(keyboard);
    }
  } else {
    // Remove virtual keyboard if disabled
    const keyboard = document.getElementById('virtual-keyboard');
    if (keyboard) keyboard.remove();
  }
  
  // Apply keyboard navigation
  if (settings.keyboardNavigation) {
    // This is mostly already built into browsers, but we can enhance it
    cssRules += `
      a:focus, button:focus, input:focus, select:focus, textarea:focus, [role="button"]:focus {
        outline: 3px solid #4a6cf7 !important;
        outline-offset: 2px !important;
      }
    `;
  }
  
  // Add all CSS rules to the style element
  styleElement.textContent = cssRules;
  document.head.appendChild(styleElement);
}

// Helper function to get contrast mode styles
function getContrastModeStyles(contrastMode: string): string {
  switch (contrastMode) {
    case 'increased':
      return `
        /* Apply contrast to everything except the widget */
        html body *:not([data-accessibility-widget="true"]):not([data-accessibility-widget="true"] *) {
          background-color: #ffffff !important;
          color: #000000 !important;
          border-color: #000000 !important;
        }
        
        /* Make input fields and form elements clearly visible */
        html body input:not([data-accessibility-widget="true"] *),
        html body textarea:not([data-accessibility-widget="true"] *),
        html body select:not([data-accessibility-widget="true"] *),
        html body button:not([data-accessibility-widget="true"] *) {
          background-color: #ffffff !important;
          color: #000000 !important;
          border: 1px solid #000000 !important;
        }
        
        /* Make links clearly visible but still distinct */
        html body a:not([data-accessibility-widget="true"] *),
        html body [role="link"]:not([data-accessibility-widget="true"] *) {
          color: #0000cc !important;
          text-decoration: underline !important;
        }
        
        /* Ensure all text is highly readable */
        html body p:not([data-accessibility-widget="true"] *),
        html body div:not([data-accessibility-widget="true"]):not([data-accessibility-widget="true"] *),
        html body span:not([data-accessibility-widget="true"] *),
        html body li:not([data-accessibility-widget="true"] *),
        html body label:not([data-accessibility-widget="true"] *),
        html body td:not([data-accessibility-widget="true"] *),
        html body th:not([data-accessibility-widget="true"] *) {
          color: #000000 !important;
        }
        
        /* Make headings stand out */
        html body h1:not([data-accessibility-widget="true"] *),
        html body h2:not([data-accessibility-widget="true"] *),
        html body h3:not([data-accessibility-widget="true"] *),
        html body h4:not([data-accessibility-widget="true"] *),
        html body h5:not([data-accessibility-widget="true"] *),
        html body h6:not([data-accessibility-widget="true"] *) {
          color: #000000 !important;
          border-bottom: 1px solid #000000 !important;
        }
        `;
    case 'high':
      return `
        /* Apply to all elements EXCEPT the widget - gelbe Schrift auf schwarzem Hintergrund */
        html body *:not([data-accessibility-widget="true"]):not([data-accessibility-widget="true"] *) {
          background-color: #000000 !important;
          color: #ffff00 !important;
          border-color: #ffff00 !important;
        }
        
        /* Make links and buttons distinct */
        html body a:not([data-accessibility-widget="true"] *),
        html body button:not([data-accessibility-widget="true"] *),
        html body [role="button"]:not([data-accessibility-widget="true"] *),
        html body [role="link"]:not([data-accessibility-widget="true"] *) {
          background-color: #000000 !important;
          color: #ffff00 !important;
          border: 2px solid #ffff00 !important;
          text-decoration: underline !important;
        }
        
        /* Make forms accessible */
        html body input:not([data-accessibility-widget="true"] *),
        html body textarea:not([data-accessibility-widget="true"] *),
        html body select:not([data-accessibility-widget="true"] *) {
          background-color: #000000 !important;
          color: #ffff00 !important;
          border: 2px solid #ffff00 !important;
        }
        
        /* Ensure headers stand out */
        html body h1:not([data-accessibility-widget="true"] *),
        html body h2:not([data-accessibility-widget="true"] *),
        html body h3:not([data-accessibility-widget="true"] *),
        html body h4:not([data-accessibility-widget="true"] *),
        html body h5:not([data-accessibility-widget="true"] *),
        html body h6:not([data-accessibility-widget="true"] *) {
          background-color: #000000 !important;
          color: #ffff00 !important;
          border-bottom: 2px solid #ffff00 !important;
        }
        `;
    case 'dark':
      return `
        /* Apply dark mode to all elements EXCEPT the widget */
        html body *:not([data-accessibility-widget="true"]):not([data-accessibility-widget="true"] *) {
          background-color: #333333 !important;
          color: #ffffff !important;
          border-color: #666666 !important;
        }
        
        /* Make links and buttons distinct */
        html body a:not([data-accessibility-widget="true"] *),
        html body button:not([data-accessibility-widget="true"] *),
        html body [role="button"]:not([data-accessibility-widget="true"] *),
        html body [role="link"]:not([data-accessibility-widget="true"] *) {
          color: #4a9eff !important;
          text-decoration: underline !important;
        }
        
        /* Customize form elements */
        html body input:not([data-accessibility-widget="true"] *),
        html body textarea:not([data-accessibility-widget="true"] *),
        html body select:not([data-accessibility-widget="true"] *) {
          background-color: #222222 !important;
          color: #ffffff !important;
          border: 1px solid #666666 !important;
        }
        
        /* Ensure headers stand out */
        html body h1:not([data-accessibility-widget="true"] *),
        html body h2:not([data-accessibility-widget="true"] *),
        html body h3:not([data-accessibility-widget="true"] *),
        html body h4:not([data-accessibility-widget="true"] *),
        html body h5:not([data-accessibility-widget="true"] *),
        html body h6:not([data-accessibility-widget="true"] *) {
          color: #ffffff !important;
          border-bottom: 1px solid #666666 !important;
        }
        
        /* Paragraph and content elements */
        html body p:not([data-accessibility-widget="true"] *),
        html body div:not([data-accessibility-widget="true"]):not([data-accessibility-widget="true"] *),
        html body span:not([data-accessibility-widget="true"] *),
        html body li:not([data-accessibility-widget="true"] *) {
          color: #f0f0f0 !important;
        }
        `;
    case 'light':
      return `
        /* Apply Sepia-Ton (Light Contrast) to all elements EXCEPT the widget */
        html body *:not([data-accessibility-widget="true"]):not([data-accessibility-widget="true"] *) {
          background-color: #f8f0dd !important; /* Warmer Sepia-Ton (Pergament) */
          color: #4b3621 !important; /* Dunkles Braun für Text */
          border-color: #704214 !important; /* Dunklerer Sepia-Ton für Ränder */
        }
        
        /* Make links and buttons distinct */
        html body a:not([data-accessibility-widget="true"] *),
        html body button:not([data-accessibility-widget="true"] *),
        html body [role="button"]:not([data-accessibility-widget="true"] *),
        html body [role="link"]:not([data-accessibility-widget="true"] *) {
          color: #8b4513 !important; /* Sattes Braun für Links */
          text-decoration: underline !important;
          border: 1px solid #8b4513 !important;
        }
        
        /* Customize form elements */
        html body input:not([data-accessibility-widget="true"] *),
        html body textarea:not([data-accessibility-widget="true"] *),
        html body select:not([data-accessibility-widget="true"] *) {
          background-color: #fff8e7 !important; /* Hellerer Sepia-Ton für Eingabefelder */
          color: #000000 !important; /* Schwarz für maximalen Kontrast in Formularen */
          border: 1px solid #704214 !important;
        }
        
        /* Ensure headers stand out */
        html body h1:not([data-accessibility-widget="true"] *),
        html body h2:not([data-accessibility-widget="true"] *),
        html body h3:not([data-accessibility-widget="true"] *),
        html body h4:not([data-accessibility-widget="true"] *),
        html body h5:not([data-accessibility-widget="true"] *),
        html body h6:not([data-accessibility-widget="true"] *) {
          color: #000000 !important; /* Schwarz für Überschriften - maximaler Kontrast */
          border-bottom: 2px solid #704214 !important;
        }
        
        /* Paragraph and content elements */
        html body p:not([data-accessibility-widget="true"] *),
        html body div:not([data-accessibility-widget="true"]):not([data-accessibility-widget="true"] *),
        html body span:not([data-accessibility-widget="true"] *),
        html body li:not([data-accessibility-widget="true"] *) {
          color: #4b3621 !important; /* Dunkles Braun für normalen Text */
        }
        `;
    default:
      return '';
  }
}

// Helper function to get font family styles
function getFontFamilyStyles(fontFamily: string): string {
  switch (fontFamily) {
    case 'readable':
      return `
        /* Apply readable font only to website content, NOT to the widget */
        html body *:not([data-accessibility-widget="true"]):not([data-accessibility-widget="true"] *) {
          font-family: Arial, Helvetica, sans-serif !important;
        }
        `;
    case 'dyslexic':
      return `
        @font-face {
          font-family: 'OpenDyslexic';
          src: url('https://cdn.jsdelivr.net/npm/open-dyslexic@1.0.3/woff/OpenDyslexic-Regular.woff') format('woff');
          font-weight: normal;
          font-style: normal;
        }
        /* Apply dyslexic font only to website content, NOT to the widget */
        html body *:not([data-accessibility-widget="true"]):not([data-accessibility-widget="true"] *) {
          font-family: 'OpenDyslexic', Comic Sans MS, cursive !important;
        }
        `;
    default:
      return '';
  }
}
